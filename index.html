<!DOCTYPE html>
<html>
  <head>
    <title>Italia Feriehefte - Oversiktskart</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
        <link rel="manifest" href="manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
      }
      .legend {
        background: white;
        padding: 8px;
        font-size: 14px;
        line-height: 1.4em;
        color: #333;
      }
      .legend div {
        margin-bottom: 4px;
      }
      .legend span {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 6px;
        vertical-align: middle;
      }
      .leaflet-popup-content button {
        margin-top: 5px;
        padding: 4px 8px;
        font-size: 13px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script type="module">
      const standard = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "¬© OpenStreetMap contributors",
        }
      );

      const satellite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles ¬© Esri",
        }
      );

      const labels = L.tileLayer(
        "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Labels ¬© Esri",
        }
      );

      const satelliteWithLabels = L.layerGroup([satellite, labels]);

      const map = L.map("map", {
        center: [43.78, 10.86],
        zoom: 9,
        layers: [satelliteWithLabels],
      });

      const baseMaps = {
        Standardkart: standard,
        "Satellitt med stedsnavn": satelliteWithLabels,
      };

      L.control.layers(baseMaps).addTo(map);

      const categoryColors = {
        restaurant: "red",
        sight: "blue",
        stay: "violet",
        activity: "orange",
        city: "gold",
        golf: "green",
      };

      function createIcon(color) {
        return L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
          shadowUrl:
            "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41],
        });
      }

      const icons = {};
      const visitedIcons = {};
      for (const [cat, color] of Object.entries(categoryColors)) {
        icons[cat] = createIcon(color);
        visitedIcons[cat] = createIcon("grey");
      }

      const locations = [
        {
          name: "Hjemme",
          coords: [43.824634, 10.895776],
          category: "stay",
          description:  'Verdens beste plass<br><a href="https://www.google.com/maps/place/Via+Giugnano,+125,+51035+Lamporecchio+PT,+Italia/@43.8242991,10.8952935,177m/data=!3m2!1e3!4b1!4m6!3m5!1s0x132a61612b4df657:0xe2016d632271b0a!8m2!3d43.8242981!4d10.8959383!16s%2Fg%2F11g1pl4vq2?entry=ttu&g_ep=EgoyMDI1MDUyOC4wIKXMDSoASAFQAw%3D%3D" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.booking.com/hotel/it/holiday-home-dependance.en-gb.html",
        },
        {
          name: "La Giostra",
          coords: [43.772093, 11.262055],
          category: "restaurant",
          description:
            'Romantisk restaurant med historisk atmosf√¶re og klassiske toskanske retter.<br><a href="https://maps.app.goo.gl/VHGeb5vJhJLYvNtj6" target="_blank">√Öpne i Google Maps</a>',
          link: "https://ristorantelagiostra.com/en/ristorante-la-giostra/",
        },
        {
          name: "Trattoria ZaZa",
          coords: [43.776369, 11.254427],
          category: "restaurant",
          description: 'Tradisjonell toskansk trattoria med levende atmosf√¶re.<br><a href="https://maps.app.goo.gl/JJ8AqDugixujNkTr6" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.trattoriazaza.it/",
        },
        {
          name: "Uffizi-galleriet",
          coords: [43.767753, 11.255285],
          category: "sight",
          description:
            'Verdenskjent kunstmuseum med verker av Michelangelo, Botticelli og da Vinci.<br><a href="https://maps.app.goo.gl/vgjiW3hrMiBwsziA7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.uffizi.it/en/the-uffizi",
        },
        {
          name: "Santa Maria del Fiore",
          coords: [43.773142, 11.255570],
          category: "sight",
          description:
            'Katedral med ikonisk kuppel av Brunelleschi og rik historie. En av verdens st√∏rste kirker.<br><a href="https://maps.app.goo.gl/wZKAG8JDqSW48xbs5" target="_blank">√Öpne i Google Maps</a>',
          link: "https://duomo.firenze.it/en/home",
        },
        {
          name: "Matlagingskurs ‚Äì lokal mat p√• g√•rd",
          coords: [43.807085, 10.921517],
          category: "activity",
          description: 'Lag autentisk toskansk mat med lokale r√•varer.<br><a href="https://maps.app.goo.gl/spEDqHPApUHEneNv7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.tripadvisor.com/AttractionProductReview-g635877-d27795468",
        },
        {
          name: "Golf Club Bellosguardo Vinci",
          coords: [43.762871, 10.920013],
          category: "golf",
          description:
            'Vakker 9-hulls golfbane med utsikt over det toskanske landskapet.<br><a href="https://maps.app.goo.gl/jhTv8hgwDq9hGjLz8" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.golfbellosguardovinci.it/",
        },
        {
          name: "Villa Rospigliosi",
          coords: [43.822091, 10.906136],
          category: "sight",
          description:
            'Historisk villa fra 1600-tallet med arkitektonisk verdi.<br><a href="https://maps.app.goo.gl/L6Go8nae2RyDxYST7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://no.tripadvisor.com/Hotel_Review-g635877-d12659975-Reviews-Villa_Rospigliosi-Lamporecchio_Province_of_Pistoia_Tuscany.html?m=19905",
        },
        {
          name: "Montecatini Golf",
          coords: [43.852462, 10.864996],
          category: "golf",
          description:'18-hulls bane med vakker utsikt.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "http://www.montecatinigolf.com/en/default.aspx",
        },
        {
          name: "Le Pavoniere Golf & Country Club",
          coords: [43.842523, 11.057157],
          category: "golf",
          description:
            'Designet av Arnold Palmer, kjent for sitt utfordrende oppsett.<br><a href="https://maps.app.goo.gl/JsEPxWqFpCwr5enu5" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.pavoniere.it/",
        },
        {
          name: "Vinci",
          coords: [43.784621, 10.924755],
          category: "city",
          description:
            'Leonardo da Vincis f√∏deby, med museum og vakker utsikt.<br><a href="https://maps.app.goo.gl/7W6PPHttLwX9NhGLA" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.tripadvisor.com/Tourism-g187903-Vinci_Tuscany-Vacations.html",
        },
        {
          name: "Monsummano Terme",
          coords: [43.868972, 10.812330],
          category: "city",
          description:
            'Koselig italiensk sm√•by med spa og god mat.<br><a href="https://maps.app.goo.gl/qVosMDsi9KY27EKz8" target="_blank">√Öpne i Google Maps</a>',
          link: "https://no.tripadvisor.com/Tourism-g1028703-Monsummano_Terme_Province_of_Pistoia_Tuscany-Vacations.html",
        },
        {
          name: "Det skjeve t√•rn i Pisa",
          coords: [43.722960, 10.396361],
          category: "sight",
          description:
            'Trenger ingen beskrivelse.<br><a href="https://maps.app.goo.gl/oNkxx67HRF6ruAWU8" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.opapisa.it/en/square-of-miracles/tower/",
        },
        {
          name: "Chiesa Santi Baronto e Desiderio",
          coords: [43.8541, 10.8832],
          category: "sight",
          description:
            'En middelaldersk kirke kjent for sine religi√∏se kunstverk.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.lamporecchio.it/cultura/chiesa-santi-baronto-e-desiderio",
        },
        {
          name: "Lamporecchio Trekking",
          coords: [43.82, 10.89],
          category: "activity",
          description:
            'Turforslag for √• utforske Lamporecchios vakre naturomr√•der til fots.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.turismotoscana.it/en/ideas/trekking-in-lamporecchio",
        },
        {
          name: "Galleria dell'Accademia",
          coords: [43.7769, 11.2583],
          category: "sight",
          description:
            'Ber√∏mt kunstgalleri i Firenze, hjem til Michelangelos David.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.galleriaaccademiafirenze.it/en/",
        },
        {
          name: "Ponte Vecchio",
          coords: [43.7687, 11.2531],
          category: "sight",
          description:
            'Historisk bro over elven Arno, kjent for sine butikker og vakker utsikt.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.visitflorence.com/florence-monuments/ponte-vecchio.html",
        },
        {
          name: "Piazzale Michelangelo",
          coords: [43.7629, 11.2656],
          category: "sight",
          description:
            'Utsiktspunkt med panoramautsikt over Firenze og Arno-dalen.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.visitflorence.com/florence-monuments/piazzale-michelangelo.html",
        },
        {
          name: "Corridoio Vasariano",
          coords: [43.7676, 11.2544],
          category: "sight",
          description:
            'Hemmelig gangvei som forbinder Palazzo Vecchio med Palazzo Pitti.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.uffizi.it/en/corridoio-vasariano",
        },
        {
          name: "Museo Casa Giusti",
          coords: [43.8288, 10.8978],
          category: "sight",
          description:
            'Museet til den italienske dikteren Mario Giusti, omgitt av vakre hager.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.museocasagiusti.it/",
        },
        {
          name: "Padule di Fucecchio",
          coords: [43.8167, 10.7833],
          category: "sight",
          description:
            'Italias st√∏rste v√•tmarksomr√•de med rikt fugleliv og flotte turmuligheter.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.paduledifucecchio.eu/en/",
        },
        {
          name: "Palazzo Pitti",
          coords: [43.7649, 11.2486],
          category: "sight",
          description: 
            'Stor renessansepalass med flere museer og vakre hager.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.palazzopitti.it/en",
        },
        {
          name: "Boboli Gardens",
          coords: [43.7631, 11.2502],
          category: "sight",
          description:
            'Historiske italienske hager med skulpturer og fantastisk utsikt over Firenze.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.uffizi.it/en/boboli-garden",
        },
        {
          name: "Basilica di Santa Croce",
          coords: [43.7681, 11.2626],
          category: "sight",
          description:
            'Ber√∏mt kirke hvor kjente italienere som Michelangelo og Galileo er gravlagt.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.santacroceopera.it/en/",
        },
        {
          name: "Mercato Centrale",
          coords: [43.7762, 11.2535],
          category: "sight",
          description:
            'Pulserende matmarked med lokale r√•varer og street food i Firenze.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.mercatocentrale.it/en/",
        },
        {
          name: "Trattoria Toscana da Bule",
          coords: [43.8269, 10.8994],
          category: "restaurant",
          description:
            'Koselig trattoria som serverer tradisjonell toskansk mat.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.tripadvisor.com/Restaurant_Review-g635877-d1234567-Reviews-Trattoria_Toscana_da_Bule-Lamporecchio_Province_of_Pistoia_Tuscany.html",
        },
        {
          name: "Ristorante il Rifugio",
          coords: [43.8275, 10.8956],
          category: "restaurant",
          description:
            'Familiedrevet restaurant kjent for lokale spesialiteter og hyggelig atmosf√¶re.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.ristoranteilrifugio.it/",
        },
        {
          name: "La Dispensa",
          coords: [43.832, 10.8999],
          category: "restaurant",
          description:
            'Moderne restaurant med fokus p√• ferske, lokale r√•varer.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.ladispensa.it/",
        },
        {
          name: "Pizzeria Da Vito",
          coords: [43.8297, 10.9011],
          category: "restaurant",
          description: 
            'Popul√¶r pizzeria med ekte italiensk atmosf√¶re.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.facebook.com/pizzeriadavito",
        },
        {
          name: "Bar Pasticceria Stefanelli",
          coords: [43.8284, 10.903],
          category: "restaurant",
          description:
            'Kaffebar og konditori med deilige s√∏tsaker og lokale bakevarer.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.pasticceriastefanelli.it/",
        },
        {
          name: "La M√©nag√®re",
          coords: [43.7746, 11.2553],
          category: "restaurant",
          description:
            'Trendy sted i Firenze som kombinerer kaf√©, blomsterbutikk og restaurant.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.lamenagere.it/",
        },
        {
          name: "Trattoria Mario",
          coords: [43.7762, 11.2526],
          category: "restaurant",
          description:
            'Autentisk og livlig trattoria, kjent for toskanske spesialiteter.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.trattoriamario.com/",
        },
        {
          name: "Osteria Santo Spirito",
          coords: [43.7652, 11.2522],
          category: "restaurant",
          description:
            'Tradisjonell osteria i hjertet av Firenze med sjarmerende atmosf√¶re.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.osteriasantospirito.com/",
        },
        {
          name: "Gelateria dei Neri",
          coords: [43.7689, 11.2604],
          category: "restaurant",
          description:
            'Popul√¶rt iskremsted kjent for sine kremete og naturlige smaker.<br><a href="https://maps.app.goo.gl/kZ9hU3n34kwNohmf7" target="_blank">√Öpne i Google Maps</a>',
          link: "https://www.gelateriadeineri.com/",
        },
      ];

      const { createClient } = window.supabase;
      const supabaseUrl = "https://jnqocfclduaagwxsixjs.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpucW9jZmNsZHVhYWd3eHNpeGpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg5NTkzMjksImV4cCI6MjA2NDUzNTMyOX0.Jr5dDwe6wGZXKhZ7iW1t9DsVVR4NqFr4MrUWY78zHd0";
      let supabase;

      // Hent bes√∏ksstatus fra Supabase ved lasting av siden
      async function getVisitedStatus() {
        if (!supabase) {
          supabase = createClient(supabaseUrl, supabaseKey);
        }
        const { data, error } = await supabase.from("checkin").select();
        if (error) {
          console.error("Supabase fetch error:", error);
          return;
        }

        const _visitedStatus = {};

        if (Array.isArray(data)) {
          data.forEach((row) => {
            _visitedStatus[row.index] = !!row.is_checked;
          });
          return _visitedStatus;
        }
      }
      // Hent status fra localStorage eller lag tomt objekt
      const visitedStatus = await getVisitedStatus();

      async function saveVisitedStatusToDatabase(index, is_checked) {
        if (!supabase) {
          supabase = createClient(supabaseUrl, supabaseKey);
        }

        const { data, error } = await supabase
          .from("checkin")
          .upsert([{ index, is_checked }], { onConflict: ["index"] });

        if (error) {
          console.error("Supabase error:", error);
        }
      }

      function toggleVisited(index) {
        const loc = locations[index];
        loc.visited = !loc.visited;
        visitedStatus[index] = loc.visited;
        saveVisitedStatusToDatabase(index, loc.visited);

        const newIcon = loc.visited
          ? visitedIcons[loc.category]
          : icons[loc.category];
        loc.marker.setIcon(newIcon);
        updatePopupContent(index, loc.visited);
      }
      window.toggleVisited = toggleVisited;
      function updatePopupContent(index) {
        const loc = locations[index];
        const btnText = loc.visited
          ? "‚ùå Unmark visited"
          : "‚úÖ Mark as visited";
        const popupContent = `
      <b style="color:${categoryColors[loc.category]}">${loc.name}</b><br>
      <i>${loc.description}</i><br>
      <a href="${loc.link}" target="_blank">Les mer</a><br>
      <button onclick="toggleVisited(${index})">${btnText}</button>
    `;

        if (!loc.marker.getPopup()) {
          loc.marker.bindPopup(popupContent);
        } else {
          loc.marker.getPopup().setContent(popupContent);
        }
        loc.marker.openPopup();
      }
        function getSavedFilterState() {
  const saved = localStorage.getItem('categoryFilters');
  return saved ? JSON.parse(saved) : Object.keys(categoryColors);
}

function saveFilterState(selectedCategories) {
  localStorage.setItem('categoryFilters', JSON.stringify(selectedCategories));
}

function updateMarkersVisibility() {
  const checkedCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(
    (input) => input.value
  );
  saveFilterState(checkedCategories);
  locations.forEach((loc) => {
    if (!loc.marker) return;
    if (checkedCategories.includes(loc.category)) {
      if (!map.hasLayer(loc.marker)) map.addLayer(loc.marker);
    } else {
      if (map.hasLayer(loc.marker)) map.removeLayer(loc.marker);
    }
  });
}

// Create filter controls
const filterContainer = L.control({ position: 'topright' });
filterContainer.onAdd = function () {
  const div = L.DomUtil.create('div', 'legend');
  div.innerHTML = '<strong>Filtrer etter kategori</strong><br>';
  const savedFilters = getSavedFilterState();
  for (const cat of Object.keys(categoryColors)) {
    const label = {
      restaurant: "Restaurant",
      sight: "Severdighet",
      stay: "Overnatting",
      activity: "Aktivitet",
      golf: "Golf",
      city: "By"
    }[cat];
    const checked = savedFilters.includes(cat) ? 'checked' : '';
    div.innerHTML += `
      <label><input type="checkbox" class="category-filter" value="${cat}" ${checked}> ${label}</label><br>
    `;
  }
  div.innerHTML += `<br><button id="resetFilters">üîÑ Tilbakestill</button>`;
  return div;
};
filterContainer.addTo(map);

// Update visibility after map and controls are fully ready
setTimeout(() => {
  updateMarkersVisibility();
}, 500);

document.addEventListener('change', (e) => {
  if (e.target.classList.contains('category-filter')) {
    updateMarkersVisibility();
  }
});

document.addEventListener('click', (e) => {
  if (e.target.id === 'resetFilters') {
    document.querySelectorAll('.category-filter').forEach((checkbox) => {
      checkbox.checked = true;
    });
    updateMarkersVisibility();
  }
});


      locations.forEach((loc, index) => {
        loc.visited = !!visitedStatus[index];
        const iconToUse = loc.visited
          ? visitedIcons[loc.category]
          : icons[loc.category];
        const marker = L.marker(loc.coords, { icon: iconToUse }).addTo(map);
        loc.marker = marker;

        const btnText = loc.visited
          ? "‚ùå Unmark visited"
          : "‚úÖ Mark as visited";
        const popupContent = `
      <b style="color:${categoryColors[loc.category]}">${loc.name}</b><br>
      <i>${loc.description}</i><br>
      <a href="${loc.link}" target="_blank">Les mer</a><br>
      <button onclick="toggleVisited(${index})">${btnText}</button>
    `;
        marker.bindPopup(popupContent);
      });

      const legend = L.control({ position: "bottomright" });
      legend.onAdd = function (map) {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML = "<strong>Forklaring</strong><br>";
        for (const [cat, color] of Object.entries(categoryColors)) {
          const label = {
            restaurant: "Restaurant",
            sight: "Severdighet",
            stay: "Overnatting",
            activity: "Aktivitet",
            golf: "Golf",
            city: "By",
          }[cat];
          div.innerHTML += `<div><span style="background:${color}"></span>${label}</div>`;
        }
        return div;
      };
      legend.addTo(map);
    </script>
  </body>
</html>